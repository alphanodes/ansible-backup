---
- name: Set backup file name - {{ db }}
  ansible.builtin.set_fact:
    backup_file_name: "db-{{ db }}-{{ date_stamp }}-{{ backup_file_period }}{{ backup_db_dump_format }}"

- name: Create MySQL dump (ansible) - {{ db }}
  community.mysql.mysql_db:
    name: '{{ db }}'
    target: "{{ backup_dir }}/{{ backup_file_name }}"
    state: dump
    single_transaction: '{{ backup_mysql_single_transaction }}'
  become: "{{ backup_mysql_become | default(omit) }}"
  become_user: '{{ backup_mysql_become_user | default(omit) }}'
  when: backup_mysqldump_options == ''

- name: Create MySQL dump (native) with custom options - {{ db }}
  ansible.builtin.shell: |
    set -o pipefail
    mysqldump {{ backup_mysqldump_options }} {{ db }} | gzip > {{ backup_dir }}/{{ backup_file_name }}
  become: "{{ backup_mysql_become | default(omit) }}"
  become_user: '{{ backup_mysql_become_user | default(omit) }}'
  when: backup_mysqldump_options != ''

- name: Include checksum file
  ansible.builtin.include_tasks: checksum_file.yml
  vars:
    orig_file: '{{ backup_dir }}/{{ backup_file_name }}'
    owner: "{{ backup_mysql_become_user |Â default('root') }}"
  when: backup_create_hashfiles
